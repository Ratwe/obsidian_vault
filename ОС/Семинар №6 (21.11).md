Программные каналы - буфер типа FIFO, на котором реализована... данные перестают существовать.

Сегменты разделяемой памяти в ядре поддерживаются специальной таблицей (*сегментов разделяемой памяти*).

![[Recording 20231121172918.webm]]

В ядре имеется таблица очередей сообщений.
```c
<sys/msg.h>

struct msgid_ds
struct msgbuf
{
	long mtype;
	char mtext[MSGMAX];
}
```
Картинка очереди:
![[-2147483648_-210856.jpg]]

msgget();
msgctl();
msgshd();
msgzcv();

![[Recording 20231121173755.webm]]

![[Recording 20231121174048.webm]]
Когда какой-то процесс выбирает сообщение из очереди, ядро копирует его в АП этого процессора. После чего запись удаляется (потребляемый ресурс).

![[Recording 20231121174233.webm]]
Процесс может выбрать сообщение из очереди способами:
1. Взять самое старое сообщение (вне зависимости от типа)
2. Процесс может взять сообщение по идентификатору (нигде идентификатора этого она не видела). Если есть несколько сообщений с одним идентификатором - берётся самый старый.
3. Процесс может выбрать сообщение, числовое значение типа которого является наименьшим из меньших или равным значению типа, указанным процессов. *Может взять по типу, то тогда возьмёт минимальный, отсчитываемый от указанного типа. Указали тип 15, его нет, а есть 12, 11, 10 - возьмётся тип 10.* Если есть несколько удовлетворяющих сообщений этого типа - берётся самое старое.
Можно сделать вывод, что идентификатор это тип.

Для чего это сделано? Чтобы процесс не блокировался при отправке и приёме сообщения. Вспомним три состояния блокировки процесса при передаче сообщений из [[Лекция №9 (27.10)]].
![[20231027_160206.jpg]]
...процесс может выбрать, каким способом процесс получит сообщение.

Пример: 
```c
...
#include <sys/msh.h>
#ifndef MSGMAX
#define MSGMAX 1024
#endif

struct mbuf
{
	long mtype;
	char mtext[MSGMAX];
} mobj = {15, "aaa"};

int main()
{
	int fd = msgget(100, IPC_CREATE | IPC_EXCL | 0632); // EXCL - Execute Control. Если существует сегмент? очередь сообщений? с таким идентификатором, то возвращается ошибка.
	if (fd == -1 || msgsnd(fd, &mobj, strlen(mobj.mtext) + 1, IPC_NOWAIT)) // IPC_NOWAIT - процесс не хочет блокироваться в результате отправки
		perror("msg");
	return 0;
}
```
Таким образом, блокировки не являются обязательными при отправке сообщений (IPC_NOWAIT указывает на то, что процесс не будет блокироваться).

# [[Демоны]]
Попросила нас открыть ![[Стивенс_Р_Раго_С_UNIX_Профессиональное_программирование_2007.djvu]] на 504 странице.
![[Recording 20231121180923.webm]]Опции:
-a вывод всех процессов
-x вывод процессов, не имеющих управляющих терминалов
-j вывод дополнительных сведений

Мы будем писать многопоточного демона.

Смотрим листинг 13.3...

![[Recording 20231121182135.webm]]

## Правила программирования демонов
1. Вызвать umask(0) - маска режима создания файла сбрасывается. Child'ы наследуют сброшенную маску режима создания файла.
2. fork() - создаётся процесс-потомок и процесс-предок завершается. Делается для того, чтобы процесс (чайлд), ставший лидером группы, не стал лидером группы. Становится сиротой, его усыновляет терминальный процесс, а в терминальной группе лидером он быть не может.
3. setsid() - set session identifier. Она и делает процесс демоном. Он становится лидером группы, в которой находится он один.
	**В Linux fork() вызывать два раза не надо.**
	У нас должно быть три одинаковых идентификатора: собственный, группы и сессии.
4. chdir("/") - переходим в корневой каталог.
	Что-то про флешку с собственной файловой системой, что её нужно подмонтировать. ![[Recording 20231121183917.webm]]
```c
getlimit(RLIMIT_NOFILE, &r1);
if(r1.rlim_max == RLIM_INFINITY)
	r1.rlim_max = 1024;
for(int i = 0; i < r1.rlim_max; i++)
	close(i);
```

```c
fd0 = open("/dev/null", O_RDWR);
fd1 = dup(0);
fd2 = dup(0);
```

Смотрим в ![[Стивенс_Р_Раго_С_UNIX_Профессиональное_программирование_2007.djvu]]
на 516 страницу на функцию lockfile().
Первый экземпляр демона создаёт файл блокировки "/var/run/daemon.pid", записывает туда свой идентификатор и устанавливает права чтения. 

---
Пусть демон в syslog записывает с интервалом 30 секунд текущее время.
Торопиться не надо. Б**о**льшая ценность - разобраться со всеми вопросами, связанными с демонами.
### Zero-links
[[00 ОС]]